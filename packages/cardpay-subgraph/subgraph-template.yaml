## TODO template-ize start blocks for networks

specVersion: 0.0.2
schema:
  file: ./schema.graphql

dataSources:
  - kind: ethereum/contract
    name: Token
    network: {NETWORK}
    source:
      abi: ERC20
      # startBlock: 21403252 # v0.6.0 version of protocol (nice to use for faster index times)
      startBlock: 20644808 # the block that the token bridge was created (and hence our CPXD tokens)
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.4
      language: wasm/assemblyscript
      entities:
        - Token
        - Account
        - TokenHolder
        - TokenTransfer
        - TokenHistory
      abis:
        - name: ERC20
          file: ./abis/ERC20.json
        - name: ERC20SymbolBytes
          file: ./abis/ERC20SymbolBytes.json
        - name: ERC20NameBytes
          file: ./abis/ERC20NameBytes.json
      eventHandlers:
        - event: Transfer(indexed address,indexed address,uint256)
          handler: handleTransfer
      file: ./src/mappings/token-{NETWORK}.ts

  - kind: ethereum/contract
    name: PrepaidCard
    network: {NETWORK}
    source:
      address: "{PREPAID_CARD_MANAGER_ADDRESS}"
      abi: PrepaidCardManager
      startBlock: 21403252 # v0.6.0 version of protocol
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.4
      language: wasm/assemblyscript
      entities:
        - PrepaidCard
        - PrepaidCardCreation
        - Transaction
        - Account
      abis:
        - name: PrepaidCardManager
          file: ./abis/generated/PrepaidCardManager.json
        - name: ERC20
          file: ./abis/ERC20.json
        - name: ERC20SymbolBytes
          file: ./abis/ERC20SymbolBytes.json
        - name: ERC20NameBytes
          file: ./abis/ERC20NameBytes.json
      eventHandlers:
        - event: CreatePrepaidCard(address,address,address,address,uint256,uint256,uint256,string)
          handler: handleCreatePrepaidCard
      file: ./src/mappings/prepaid-card.ts

  - kind: ethereum/contract
    name: Merchant
    network: {NETWORK}
    source:
      address: "{MERCHANT_MANAGER_ADDRESS}"
      abi: MerchantManager
      startBlock: 21403252 # v0.6.0 version of protocol
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.4
      language: wasm/assemblyscript
      entities:
        - Transaction
        - Account
        - MerchantSafe
        - MerchantCreation
      abis:
        - name: MerchantManager
          file: ./abis/generated/MerchantManager.json
        - name: ERC20
          file: ./abis/ERC20.json
        - name: ERC20SymbolBytes
          file: ./abis/ERC20SymbolBytes.json
        - name: ERC20NameBytes
          file: ./abis/ERC20NameBytes.json
      eventHandlers:
        - event: MerchantCreation(address,address,string)
          handler: handleMerchantCreation
      file: ./src/mappings/merchant-manager.ts

  - kind: ethereum/contract
    name: MerchantRegistrationFee
    network: {NETWORK}
    source:
      address: "{REGISTER_MERCHANT_HANDLER_ADDRESS}"
      abi: RegisterMerchantHandler
      startBlock: 21403252 # v0.6.0 version of protocol
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.4
      language: wasm/assemblyscript
      entities:
        - Transaction
        - MerchantRegistrationPayment
        - PrepaidCardPayment
      abis:
        - name: RegisterMerchantHandler
          file: ./abis/generated/RegisterMerchantHandler.json
        - name: ERC20
          file: ./abis/ERC20.json
        - name: ERC20SymbolBytes
          file: ./abis/ERC20SymbolBytes.json
        - name: ERC20NameBytes
          file: ./abis/ERC20NameBytes.json
      eventHandlers:
        - event: MerchantRegistrationFee(address,address,uint256,uint256)
          handler: handleMerchantRegistrationFee
      file: ./src/mappings/merchant-manager.ts

  - kind: ethereum/contract
    name: Payments
    network: {NETWORK}
    source:
      address: "{PAY_MERCHANT_HANDLER_ADDRESS}"
      abi: PayMerchantHandler
      startBlock: 21403252 # v0.6.0 version of protocol
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.4
      language: wasm/assemblyscript
      entities:
        - Transaction
        - PrepaidCardPayment
        - MerchantFeePayment
        - MerchantRevenue
        - MerchantRevenueEvent
      abis:
        - name: PayMerchantHandler
          file: ./abis/generated/PayMerchantHandler.json
        - name: ERC20
          file: ./abis/ERC20.json
        - name: ERC20SymbolBytes
          file: ./abis/ERC20SymbolBytes.json
        - name: ERC20NameBytes
          file: ./abis/ERC20NameBytes.json
      eventHandlers:
        - event: CustomerPayment(address,address,address,uint256,uint256)
          handler: handleMerchantPayment
        - event: MerchantFeeCollected(address,address,address,uint256)
          handler: handleMerchantFee
      file: ./src/mappings/pay-merchant-handler.ts

  - kind: ethereum/contract
    name: RevenuePool
    network: {NETWORK}
    source:
      address: "{REVENUE_POOL_ADDRESS}"
      abi: RevenuePool
      startBlock: 21403252 # v0.6.0 version of protocol
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.4
      language: wasm/assemblyscript
      entities:
        - Transaction
        - MerchantRevenue
        - MerchantClaim
        - MerchantRevenueEvent
      abis:
        - name: RevenuePool
          file: ./abis/generated/RevenuePool.json
        - name: ERC20
          file: ./abis/ERC20.json
        - name: ERC20SymbolBytes
          file: ./abis/ERC20SymbolBytes.json
        - name: ERC20NameBytes
          file: ./abis/ERC20NameBytes.json
      eventHandlers:
        - event: MerchantClaim(address,address,uint256)
          handler: handleMerchantClaim
      file: ./src/mappings/revenue-pool.ts

  - kind: ethereum/contract
    name: Spend
    network: {NETWORK}
    source:
      address: "{SPEND_ADDRESS}"
      abi: Spend
      startBlock: 21403252 # v0.6.0 version of protocol
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.4
      language: wasm/assemblyscript
      entities:
        - Transaction
        - SpendAccumulation
      abis:
        - name: Spend
          file: ./abis/generated/Spend.json
        - name: ERC20
          file: ./abis/ERC20.json
        - name: ERC20SymbolBytes
          file: ./abis/ERC20SymbolBytes.json
        - name: ERC20NameBytes
          file: ./abis/ERC20NameBytes.json
      eventHandlers:
        - event: Mint(address,uint256)
          handler: handleMint
      file: ./src/mappings/spend.ts

  - kind: ethereum/contract
    name: Depot
    network: {NETWORK}
    source:
      address: "{SUPPLIER_MANAGER_ADDRESS}"
      abi: SupplierManager
      startBlock: 21403252 # v0.6.0 version of protocol
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.4
      language: wasm/assemblyscript
      entities:
        - Safe
        - Depot
        - Transaction
      abis:
        - name: SupplierManager
          file: ./abis/generated/SupplierManager.json
        - name: ERC20
          file: ./abis/ERC20.json
        - name: ERC20SymbolBytes
          file: ./abis/ERC20SymbolBytes.json
        - name: ERC20NameBytes
          file: ./abis/ERC20NameBytes.json
      eventHandlers:
        - event: SupplierSafeCreated(address,address)
          handler: handleCreateDepot
        - event: SupplierInfoDIDUpdated(address,string)
          handler: handleSetInfoDID
      file: ./src/mappings/depot.ts

  - kind: ethereum/contract
    name: TokenBridge
    network: {NETWORK}
    source:
      address: "{HOME_TOKEN_BRIDGE_ADDRESS}"
      abi: HomeMultiAMBErc20ToErc677
      startBlock: 21403252 # v0.6.0 version of protocol
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.4
      language: wasm/assemblyscript
      entities:
        - Account
        - Depot
        - Transaction
        - SupplierInfoDIDUpdate
        - BridgeEvent
      abis:
        - name: HomeMultiAMBErc20ToErc677
          file: ./abis/HomeMultiAMBErc20ToErc677.json
        - name: ERC20
          file: ./abis/ERC20.json
        - name: ERC20SymbolBytes
          file: ./abis/ERC20SymbolBytes.json
        - name: ERC20NameBytes
          file: ./abis/ERC20NameBytes.json
      eventHandlers:
        - event: TokensBridgedToSafe(indexed address,indexed address,address,uint256,indexed bytes32)
          handler: handleTokensBridged
      file: ./src/mappings/depot.ts

  - kind: ethereum/contract
    name: Gnosis
    network: {NETWORK}
    source:
      address: "0x76E2cFc1F5Fa8F6a5b3fC4c8F4788F0116861F9B"
      abi: GnosisProxyFactory
      startBlock: 21403252 # v0.6.0 version of protocol
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.4
      language: wasm/assemblyscript
      entities:
        - Safe
        - Account
        - SafeOwner
      abis:
        - name: GnosisProxyFactory
          file: ./abis/GnosisProxyFactory.json
        - name: GnosisSafe
          file: ./abis/GnosisSafe.json
        - name: ERC20
          file: ./abis/ERC20.json
        - name: ERC20SymbolBytes
          file: ./abis/ERC20SymbolBytes.json
        - name: ERC20NameBytes
          file: ./abis/ERC20NameBytes.json
      eventHandlers:
        - event: ProxyCreation(address)
          handler: handleProxyCreation
      file: ./src/mappings/gnosis-proxy-factory.ts

templates:
  - kind: ethereum/contract
    name: GnosisSafe
    network: {NETWORK}
    source:
      abi: GnosisSafe
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.4
      language: wasm/assemblyscript
      entities:
        - SafeTransaction
        - Transaction
      abis:
        - name: GnosisSafe
          file: ./abis/GnosisSafe.json
        - name: ERC20
          file: ./abis/ERC20.json
        - name: ERC20SymbolBytes
          file: ./abis/ERC20SymbolBytes.json
        - name: ERC20NameBytes
          file: ./abis/ERC20NameBytes.json
      eventHandlers:
        - event: ExecutionSuccess(bytes32,uint256)
          handler: handleExecutionSuccess
      file: ./src/mappings/gnosis-safe.ts

