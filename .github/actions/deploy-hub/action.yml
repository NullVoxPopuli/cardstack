name: Deploy hub
description: Deploy hub using waypoint

inputs:
  ref:
    description: The branch, tag or SHA to deploy
    required: false
    default: main
  waypoint_version:
    description: Waypoint version to use
    required: false
    default: '0.4.0'
  discord_token:
    description: Authentication token for Discord bot
    required: true
  discord_channel:
    description: Discord channel to send the notification
    required: true

runs:
  using: composite
  steps:
    - name: Install apt packages including waypoint
      shell: bash
      run: |
        curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
        sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
        sudo apt-get install awscli waypoint=${{ inputs.waypoint_version }}

    - uses: volta-cli/action@v1

    - run: yarn --prefer-offline
      shell: bash

    - name: Deploy server
      run: waypoint up --app=hub -plain
      shell: bash
      env:
        WAYPOINT_SERVER_TLS: '1'
        WAYPOINT_SERVER_TLS_SKIP_VERIFY: '1'

    - name: Deploy worker
      run: waypoint up --app=hub-worker -prune-retain=0 -plain
      shell: bash
      env:
        WAYPOINT_SERVER_TLS: '1'
        WAYPOINT_SERVER_TLS_SKIP_VERIFY: '1'

    - uses: ./.github/actions/discord-message
      with:
        token: ${{ inputs.discord_token }}
        channel: ${{ inputs.discord_channel }}
        message: |
          :checkered_flag: **hub** [${{ inputs.ref }}] has been deployed to *${{ inputs.environment }}*
          :arrow_forward: Workflow: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
